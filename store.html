<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Store | FutureGames</title>

  <link rel="stylesheet" href="css/style.css">
  <script src="js/products.js"></script>
  <style>
    /* ===== Fix for product images ===== */
    .product-media {
      height: 200px; /* taller so image is visible */
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      background-color: #e0e0e0; /* neutral background for JPGs */
    }

    .product-media img {
      width: auto;
      height: 100%;
      object-fit: contain; /* show full image */
      display: block;
    }

    /* ===== Fix for description readability ===== */
    .product-body h3 {
      font-size: 18px;
      color: #111827;
      margin-bottom: 6px;
    }

    .product-body .meta,
    .product-body .desc,
    .product-body .price {
      font-size: 14px;
      color: #333;
      margin-bottom: 6px;
    }

    /* Product card styling */
    .product {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .add-cart {
      cursor: pointer;
    }

    /* Cart styling */
    .cart button {
      margin-top: 6px;
      margin-right: 6px;
    }
  </style>
</head>

<body>

  <header>
    <div class="nav-left">
      <img src="assets/images/FutureGames-logo.svg" class="logo" alt="logo">
      <a href="store.html" class="nav-btn active">Store</a>
      <a href="library.html" class="nav-btn">Library</a>
    </div>

    <div class="user-box">
      <span id="helloUser"></span>
      <button class="btn btn-outline" id="logoutBtn">Log out</button>
    </div>
  </header>

  <div class="store-wrap">
    <h1>Store</h1>

    <!-- PRODUCTS -->
    <div class="grid" id="productsGrid"></div>

    <!-- CART -->
    <div class="cart">
      <h2>Your Cart</h2>
      <div id="cartEmpty">Cart is empty.</div>
      <ul id="cartList" style="display:none;"></ul>

      <button class="btn btn-success" id="addToLibraryBtn">Add to Library</button>
      <button class="btn btn-primary" id="clearCartBtn">Clear Cart</button>
    </div>
  </div>

  <script>
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) location.href = "login.html";

    document.getElementById("helloUser").textContent = `Hi, ${currentUser.fullName}`;

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("currentUser");
      location.href = "login.html";
    };

    const cartKey = `cart_${currentUser.email}`;
    const libraryKey = `library_${currentUser.email}`;

    function getCart() { return JSON.parse(localStorage.getItem(cartKey) || "[]"); }
    function saveCart(cart) { localStorage.setItem(cartKey, JSON.stringify(cart)); }
    function getLibrary() { return JSON.parse(localStorage.getItem(libraryKey) || "[]"); }
    function saveLibrary(lib) { localStorage.setItem(libraryKey, JSON.stringify(lib)); }

    function addToCart(product) {
      const cart = getCart();
      cart.push(product);
      saveCart(cart);
      renderCart();
    }

    function removeFromCart(index) {
      const cart = getCart();
      cart.splice(index, 1);
      saveCart(cart);
      renderCart();
    }

    const cartList = document.getElementById("cartList");
    const cartEmpty = document.getElementById("cartEmpty");

    function renderCart() {
      const cart = getCart();
      if (cart.length === 0) {
        cartEmpty.style.display = "block";
        cartList.style.display = "none";
        cartList.innerHTML = "";
        return;
      }

      cartEmpty.style.display = "none";
      cartList.style.display = "block";

      cartList.innerHTML = cart.map((game, index) => `
        <li style="display:flex; justify-content:space-between; align-items:center;">
          <span>${game.name} - $${game.price}</span>
          <button onclick="removeFromCart(${index})">Remove</button>
        </li>
      `).join("");
    }

    document.getElementById("addToLibraryBtn").onclick = () => {
      const cart = getCart();
      if (cart.length === 0) return;
      const library = getLibrary();
      cart.forEach(game => {
        if (!library.find(g => g.id === game.id)) library.push(game);
      });
      saveLibrary(library);
      saveCart([]);
      renderCart();
      alert("Games added to library!");
    };

    document.getElementById("clearCartBtn").onclick = () => {
      saveCart([]);
      renderCart();
    };

    const grid = document.getElementById("productsGrid");

    function renderProducts() {
      grid.innerHTML = "";
      window.products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <div class="product-media">
            <img src="${p.image}" alt="${p.name}">
          </div>
          <div class="product-body">
            <h3>${p.name}</h3>
            <p class="meta">${p.genre} Â· Rating: ${p.rating}</p>
            <p class="desc">${p.description}</p>
            <p class="price">Price: $${p.price}</p>
            <button class="btn btn-primary add-cart">Add to Cart</button>
          </div>
        `;
        grid.appendChild(div);

        div.querySelector(".add-cart").addEventListener("click", () => addToCart(p));
      });
    }

    renderProducts();
    renderCart();
  </script>
</body>
</html>
