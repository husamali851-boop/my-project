<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Store | FutureGames</title>

  <link rel="stylesheet" href="css/store.css">
  <script src="js/products.js"></script>
  <style>
    /* Fix View Game button sizing inside product-body */
    .product-body .view-game {
      display: inline-block;
      width: auto;
      padding: 8px 14px;
      font-size: 14px;
      text-align: center;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <header>
    <div class="nav-left">
      <img src="assets/images/FutureGames-logo.svg" class="logo" alt="logo">
      <a href="store.html" class="nav-btn active">Store</a>
      <a href="library.html" class="nav-btn">Library</a>
    </div>

    <div class="user-box">
      <span id="helloUser"></span>
      <button class="btn btn-outline" id="logoutBtn">Log out</button>
    </div>
  </header>

  <div class="store-wrap">
    <h1>Store</h1>

    <!-- ===== Popular Games Carousel ===== -->
    <div class="popular-game-wrap">
      <h2>Popular Games</h2>
      <button id="carouselLeft" class="carousel-arrow">&#10094;</button>
      <canvas id="popularGameCanvas"></canvas>
      <button id="carouselRight" class="carousel-arrow">&#10095;</button>
    </div>

    <!-- ===== PRODUCTS GRID ===== -->
    <div class="grid" id="productsGrid"></div>

    <!-- ===== CART ===== -->
    <div class="cart">
      <h2>Your Cart</h2>
      <div id="cartEmpty">Cart is empty.</div>
      <ul id="cartList" style="display:none;"></ul>

      <button class="btn btn-success" id="addToLibraryBtn">Add to Library</button>
      <button class="btn btn-primary" id="clearCartBtn">Clear Cart</button>
    </div>
  </div>

  <script>
    // ===== User Logic =====
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) location.href = "login.html";
    document.getElementById("helloUser").textContent = `Hi, ${currentUser.fullName}`;
    document.getElementById("logoutBtn").onclick = () => {
      localStorage.removeItem("currentUser");
      location.href = "login.html";
    };

    const cartKey = `cart_${currentUser.email}`;
    const libraryKey = `library_${currentUser.email}`;

    function getCart() { return JSON.parse(localStorage.getItem(cartKey) || "[]"); }
    function saveCart(cart) { localStorage.setItem(cartKey, JSON.stringify(cart)); }
    function getLibrary() { return JSON.parse(localStorage.getItem(libraryKey) || "[]"); }
    function saveLibrary(lib) { localStorage.setItem(libraryKey, JSON.stringify(lib)); }

    function addToCart(product) {
      const cart = getCart();
      cart.push(product);
      saveCart(cart);
      renderCart();
    }

    function removeFromCart(index) {
      const cart = getCart();
      cart.splice(index, 1);
      saveCart(cart);
      renderCart();
    }

    const cartList = document.getElementById("cartList");
    const cartEmpty = document.getElementById("cartEmpty");

    function renderCart() {
      const cart = getCart();
      if (cart.length === 0) {
        cartEmpty.style.display = "block";
        cartList.style.display = "none";
        cartList.innerHTML = "";
        return;
      }
      cartEmpty.style.display = "none";
      cartList.style.display = "block";
      cartList.innerHTML = cart.map((game, index) => `
        <li style="display:flex; justify-content:space-between; align-items:center;">
          <span>${game.name} - $${game.price}</span>
          <button onclick="removeFromCart(${index})">Remove</button>
        </li>
      `).join("");
    }

    document.getElementById("addToLibraryBtn").onclick = () => {
      const cart = getCart();
      if (cart.length === 0) return;
      const library = getLibrary();
      cart.forEach(game => {
        if (!library.find(g => g.id === game.id)) library.push(game);
      });
      saveLibrary(library);
      saveCart([]);
      renderCart();
      alert("Games added to library!");
    };

    document.getElementById("clearCartBtn").onclick = () => {
      saveCart([]);
      renderCart();
    };

    // ===== Render Products from products.js =====
    const grid = document.getElementById("productsGrid");
    function renderProducts() {
      grid.innerHTML = "";
      window.products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <div class="product-media">
            <img src="${p.image}" alt="${p.name}">
          </div>
          <div class="product-body">
            <h3>${p.name}</h3>
            <p class="meta">${p.genre} Â· Rating: ${p.rating}</p>
            <p class="desc">${p.description}</p>
            <p class="price">Price: $${p.price}</p>
            <button class="btn btn-primary add-cart">Add to Cart</button>
            ${p.id === 1 ? '<a href="game1.html" class="btn btn-outline view-game">View Game</a>' : ''}
          </div>
        `;
        grid.appendChild(div);

        // Add to cart button
        div.querySelector(".add-cart").addEventListener("click", () => addToCart(p));
      });
    }

    renderProducts();
    renderCart();

    // ===== Popular Games Carousel =====
    const canvas = document.getElementById('popularGameCanvas');
    const ctx = canvas.getContext('2d');
    const popularImages = [
      "assets/images/games/popular1.jpg",
      "assets/images/games/popular2.jpg",
      "assets/images/games/popular3.jpg",
      "assets/images/games/popular4.jpg"
    ];
    let currentIndex = 0;

    function resizeCanvas() {
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      drawImage();
    }

    function drawImage() {
      const img = new Image();
      img.src = popularImages[currentIndex];
      img.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % popularImages.length;
      drawImage();
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + popularImages.length) % popularImages.length;
      drawImage();
    }

    document.getElementById('carouselRight').addEventListener('click', nextImage);
    document.getElementById('carouselLeft').addEventListener('click', prevImage);

    // Auto slide every 3 seconds
    setInterval(nextImage, 3000);

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

  </script>

</body>
</html>
